import {
  pgTable,
  serial,
  integer,
  varchar,
  timestamp,
  text,
  date,
  uniqueIndex,
  index,
  check,
} from 'drizzle-orm/pg-core';
import { relations, sql } from 'drizzle-orm';
import { children } from '../../parent/schema/parent.schema';

// Subjects table - stores available subjects for tutoring
export const subjects = pgTable('subjects', {
  subjectId: serial('subject_id').primaryKey(),
  name: varchar('name', { length: 100 }).notNull().unique(),
  description: text('description'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// Child subjects table - tracks subject enrollment and progress per child
export const childSubjects = pgTable('child_subjects', {
  childSubjectId: serial('child_subject_id').primaryKey(),
  childId: integer('child_id')
    .notNull()
    .references(() => children.childId, { onDelete: 'cascade' }),
  subjectId: integer('subject_id')
    .notNull()
    .references(() => subjects.subjectId, { onDelete: 'cascade' }),
  enrollmentDate: date('enrollment_date').defaultNow().notNull(),
  currentProgress: integer('current_progress').default(0).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => {
  return {
    childSubjectIdx: uniqueIndex('child_subject_idx').on(table.childId, table.subjectId),
    childIdIdx: index('child_subjects_child_id_idx').on(table.childId),
  };
});

// Sessions table - tracks tutoring sessions
export const sessions = pgTable('child_sessions', {
  sessionId: serial('session_id').primaryKey(),
  childId: integer('child_id')
    .notNull()
    .references(() => children.childId, { onDelete: 'cascade' }),
  tutorId: integer('tutor_id').notNull(), // Will reference tutors table when created
  subjectId: integer('subject_id')
    .notNull()
    .references(() => subjects.subjectId),
  startTime: timestamp('start_time').notNull(),
  endTime: timestamp('end_time').notNull(),
  durationMinutes: integer('duration_minutes').notNull(),
  status: varchar('status', { length: 20 }).default('scheduled').notNull(),
  notes: text('notes'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => {
  return {
    childIdIdx: index('child_sessions_child_id_idx').on(table.childId),
    statusIdx: index('child_sessions_status_idx').on(table.status),
    startTimeIdx: index('child_sessions_start_time_idx').on(table.startTime),
    validTimeCheck: check('valid_time_check', sql`end_time > start_time`),
    validStatusCheck: check('valid_status_check', sql`status IN ('scheduled', 'completed', 'cancelled')`),
  };
});

// Progress assessments table - tracks individual progress assessments
export const progressAssessments = pgTable('progress_assessments', {
  assessmentId: serial('assessment_id').primaryKey(),
  sessionId: integer('session_id')
    .notNull()
    .references(() => sessions.sessionId, { onDelete: 'cascade' }),
  childId: integer('child_id')
    .notNull()
    .references(() => children.childId, { onDelete: 'cascade' }),
  subjectId: integer('subject_id')
    .notNull()
    .references(() => subjects.subjectId),
  progressPercentage: integer('progress_percentage').notNull(),
  assessmentDate: timestamp('assessment_date').defaultNow().notNull(),
  tutorNotes: text('tutor_notes'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => {
  return {
    childIdIdx: index('progress_assessments_child_id_idx').on(table.childId),
    subjectIdIdx: index('progress_assessments_subject_id_idx').on(table.subjectId),
    validProgressCheck: check('valid_progress_check', sql`progress_percentage BETWEEN 0 AND 100`),
  };
});

// Define relations for subjects table
export const subjectsRelations = relations(subjects, ({ many }) => ({
  childSubjects: many(childSubjects),
  sessions: many(sessions),
  progressAssessments: many(progressAssessments),
}));

// Define relations for childSubjects table
export const childSubjectsRelations = relations(childSubjects, ({ one }) => ({
  child: one(children, {
    fields: [childSubjects.childId],
    references: [children.childId],
  }),
  subject: one(subjects, {
    fields: [childSubjects.subjectId],
    references: [subjects.subjectId],
  }),
}));

// Define relations for sessions table
export const sessionsRelations = relations(sessions, ({ one, many }) => ({
  child: one(children, {
    fields: [sessions.childId],
    references: [children.childId],
  }),
  subject: one(subjects, {
    fields: [sessions.subjectId],
    references: [subjects.subjectId],
  }),
  progressAssessments: many(progressAssessments),
}));

// Define relations for progressAssessments table
export const progressAssessmentsRelations = relations(progressAssessments, ({ one }) => ({
  session: one(sessions, {
    fields: [progressAssessments.sessionId],
    references: [sessions.sessionId],
  }),
  child: one(children, {
    fields: [progressAssessments.childId],
    references: [children.childId],
  }),
  subject: one(subjects, {
    fields: [progressAssessments.subjectId],
    references: [subjects.subjectId],
  }),
}));
